<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - Calm Tasks</title>
  <link rel="stylesheet" th:href="@{/css/style.css}">
  <script src="https://unpkg.com/lucide@latest"></script>
  <style>
    .modal { display: none; position: fixed; inset: 0; z-index: 50; background: rgba(0,0,0,0.2); align-items: center; justify-content: center; padding: 1rem; }
    .modal.active { display: flex; }
    .hidden { display: none !important; }
    .ml-13 { margin-left: 3.25rem; }
    .btn-delete:hover { color: #ef4444; }
    .btn-edit:hover { color: #3b82f6; }
    .task-card { display: flex; align-items: flex-start; gap: 1rem; }
    .flex-1 { flex: 1; }
    .status-badge { padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 500; margin-left: 0.5rem; }
    .status-todo { background: #f3f4f6; color: #374151; }
    .status-progress { background: #dbeafe; color: #1e40af; }
    .status-completed { background: #dcfce7; color: #166534; }
  </style>
</head>
<body class="dashboard-body">
<div class="layout-wrapper">

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-header">
      <div class="logo-container">
        <i data-lucide="list-todo" class="icon-primary"></i>
      </div>
      <h2>Calm Tasks</h2>
      <p class="muted-text ml-13">Your mindful to-do list</p>
    </div>

    <nav class="sidebar-nav" style="flex: 1">
      <a th:href="@{/tasks-view}" class="nav-item active">
        <i data-lucide="list-todo"></i>
        <span>Tasks</span>
      </a>
      <a th:href="@{/profile}" class="nav-item">
        <i data-lucide="user"></i>
        <span>Profile</span>
      </a>
    </nav>

    <form th:action="@{/auth/logout}" method="post" id="logoutForm" style="display: none;"></form>
    <a href="javascript:void(0)" onclick="document.getElementById('logoutForm').submit();" class="nav-item logout">
      <i data-lucide="log-out"></i>
      <span>Sign Out</span>
    </a>
  </aside>

  <main class="main-content">
    <div class="max-w-5xl mx-auto">
      <header class="content-header" style="margin-bottom: 2rem;">
        <h1>My Tasks</h1>
        <p class="muted-text">Organize your day with intention</p>
      </header>

      <div class="filter-group" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; margin-bottom: 2rem;">
        <div class="pills-container" style="display: flex; gap: 0.5rem;">
          <button class="pill active" onclick="filterTasks('all', this)">Todas</button>
          <button class="pill" onclick="filterTasks('TODO', this)">A Fazer</button>
          <button class="pill" onclick="filterTasks('IN_PROGRESS', this)">Em Andamento</button>
          <button class="pill" onclick="filterTasks('COMPLETED', this)">Concluídas</button>
        </div>

        <button class="btn-signin" style="width: auto; padding: 0 1.5rem; margin-top: 0;" onclick="openCreateModal()">
          <i data-lucide="plus" style="display: inline-block; vertical-align: middle; margin-right: 0.5rem;"></i>
          Add New Task
        </button>
      </div>

      <div id="taskContainer" class="task-container">
        <div th:each="task : ${listTasks}" class="task-card" th:data-status="${task.status.name()}">
          <button class="toggle-btn" th:onclick="'toggleTaskStatus(' + ${task.id} + ')'">
            <i th:if="${task.status.name() == 'COMPLETED'}" data-lucide="check-circle-2" class="icon-done"></i>
            <i th:unless="${task.status.name() == 'COMPLETED'}" data-lucide="circle" class="icon-todo"></i>
          </button>

          <div class="task-text flex-1">
            <div style="display: flex; align-items: center;">
              <h3 th:text="${task.title}" th:classappend="${task.status.name() == 'COMPLETED'} ? 'line-through' : ''">Task Title</h3>

              <span th:class="'status-badge ' + (${task.status.name() == 'TODO'} ? 'status-todo' : (${task.status.name() == 'IN_PROGRESS'} ? 'status-progress' : 'status-completed'))"
                    th:text="${task.status}">STATUS</span>
            </div>
            <p th:text="${task.description}" class="muted-text">Description</p>
          </div>

          <div style="display: flex; gap: 0.5rem;">
            <button class="btn-edit" style="background:none; border:none; cursor:pointer;"
                    th:data-id="${task.id}"
                    th:data-title="${task.title}"
                    th:data-description="${task.description}"
                    th:data-status="${task.status.name()}"
                    onclick="prepareEditModal(this)">
              <i data-lucide="pencil" class="muted-text"></i>
            </button>
            <button class="btn-delete" style="background:none; border:none; cursor:pointer;" th:onclick="'deleteTask(' + ${task.id} + ')'">
              <i data-lucide="trash-2" class="muted-text"></i>
            </button>
          </div>
        </div>

        <div th:if="${#lists.isEmpty(listTasks)}" id="emptyState" class="text-center py-16">
          <p class="muted-text">No tasks found</p>
        </div>
      </div>
    </div>
  </main>
</div>

<div id="taskModal" class="modal">
  <div class="login-card" style="max-width: 500px; position: relative;">
    <button onclick="toggleModal(false)" style="position: absolute; right: 1.5rem; top: 1.5rem; background: none; border: none; cursor: pointer;">
      <i data-lucide="x"></i>
    </button>

    <h2 id="modalTitle" style="text-align: left; margin-bottom: 1.5rem;">Create New Task</h2>
    <input type="hidden" id="taskId">

    <div class="input-group">
      <label for="taskTitle">Task Title</label>
      <input type="text" id="taskTitle" placeholder="Enter task title">
    </div>

    <div class="input-group">
      <label for="taskDescription">Description</label>
      <input type="text" id="taskDescription" placeholder="Enter task description">
    </div>

    <div class="input-group">
      <label for="taskStatus">Status</label>
      <select id="taskStatus" class="h-12 rounded-2xl bg-input-background border-border" style="width: 100%; padding: 0 1rem; border: 1px solid var(--border);">
        <option value="TODO">A Fazer</option>
        <option value="IN_PROGRESS">Em Andamento</option>
        <option value="COMPLETED">Concluído</option>
      </select>
    </div>

    <div style="display: flex; gap: 1rem; margin-top: 2rem;">
      <button class="pill" style="flex: 1; height: 3.5rem;" onclick="toggleModal(false)">Cancel</button>
      <button id="modalSubmitBtn" class="btn-signin" style="flex: 1; margin-top: 0;" onclick="handleSaveTask()">Create Task</button>
    </div>
  </div>
</div>

<script>
  lucide.createIcons();

  function toggleModal(show) {
    document.getElementById('taskModal').classList.toggle('active', show);
  }

  function openCreateModal() {
    document.getElementById('modalTitle').innerText = "Create New Task";
    document.getElementById('modalSubmitBtn').innerText = "Create Task";
    document.getElementById('taskId').value = "";
    document.getElementById('taskTitle').value = "";
    document.getElementById('taskDescription').value = "";
    document.getElementById('taskStatus').value = "TODO";
    toggleModal(true);
  }

  function prepareEditModal(btn) {
    const id = btn.getAttribute('data-id');
    const title = btn.getAttribute('data-title');
    const description = btn.getAttribute('data-description');
    const status = btn.getAttribute('data-status');

    document.getElementById('modalTitle').innerText = "Edit Task";
    document.getElementById('modalSubmitBtn').innerText = "Update Task";
    document.getElementById('taskId').value = id;
    document.getElementById('taskTitle').value = title;
    document.getElementById('taskDescription').value = description;
    document.getElementById('taskStatus').value = status;
    toggleModal(true);
  }

  async function handleSaveTask() {
    const id = document.getElementById('taskId').value;
    const title = document.getElementById('taskTitle').value;
    const description = document.getElementById('taskDescription').value;
    const status = document.getElementById('taskStatus').value;

    if (!title) return alert("Title is required");

    const url = id ? `/tasks/${id}` : '/tasks';
    const method = id ? 'PUT' : 'POST';

    const response = await fetch(url, {
      method: method,
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        taskTitle: title,
        taskDescription: description,
        taskStatus: status
      })
    });

    if (response.ok) {
      window.location.reload();
    } else {
      alert("Erro ao salvar tarefa");
    }
  }

  function filterTasks(status, btn) {
    document.querySelectorAll('.pill').forEach(p => p.classList.remove('active'));
    btn.classList.add('active');

    const cards = document.querySelectorAll('.task-card');
    cards.forEach(card => {
      if (status === 'all' || card.getAttribute('data-status') === status) {
        card.classList.remove('hidden');
      } else {
        card.classList.add('hidden');
      }
    });
  }

  async function deleteTask(id) {
    if (!confirm("Deseja realmente excluir esta tarefa?")) return;
    try {
      const response = await fetch(`/tasks/${id}`, {
        method: 'DELETE' // Envia a requisição DELETE
      });

      if (response.ok) {
        window.location.reload();
      } else {
        alert("Erro ao excluir a tarefa.");
      }
    } catch (error) {
      console.error("Erro na requisição:", error);
      alert("Erro de conexão com o servidor.");
    }
  }

  async function toggleTaskStatus(id) {
    window.location.reload();
  }
</script>
</body>
</html>